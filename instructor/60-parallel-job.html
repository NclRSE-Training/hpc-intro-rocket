<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Introduction to HPC: Running a parallel job</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../60-parallel-job.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Introduction to HPC
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Introduction to HPC
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to HPC
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 58%" class="percentage">
    58%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 58%" aria-valuenow="58" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../60-parallel-job.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="10-hpc-intro.html">1. Why use an HPC System?</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="20-cluster.html">2. Working on an HPC system</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="30-scheduler.html">3. Working with the scheduler</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="40-modules.html">4. Accessing software via Modules</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="50-transferring-files.html">5. Transferring files with remote computers</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        6. Running a parallel job
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#get-code-for-this-episode">Get code for this episode</a></li>
<li><a href="#a-serial-solution-to-the-problem">A Serial Solution to the Problem</a></li>
<li><a href="#random-number-generation">Random Number Generation</a></li>
<li><a href="#measuring-performance-of-the-serial-solution">Measuring Performance of the Serial Solution</a></li>
<li><a href="#running-the-serial-job-on-a-compute-node">Running the Serial Job on a Compute Node</a></li>
<li><a href="#running-the-parallel-job">Running the Parallel Job</a></li>
<li><a href="#how-much-does-mpi-improve-performance">How Much Does MPI Improve Performance?</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="70-resources.html">7. Using resources effectively</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="80-responsibility.html">8. Using shared resources responsibly</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/50-transferring-files.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/70-resources.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/50-transferring-files.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Transferring files
        </a>
        <a class="chapter-link float-end" href="../instructor/70-resources.html" rel="next">
          Next: Using resources...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Running a parallel job</h1>
        <p>Last updated on 2025-03-06 |

        <a href="https://github.com/NclRSE-Training/hpc-intro-rocket/edit/main/episodes/60-parallel-job.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 90 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>“How do we execute a task in parallel?”</li>
<li>“What benefits arise from parallel execution?”</li>
<li>“What are the limits of gains from execution in parallel?”</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>“Construct a program that can execute in parallel.”</li>
<li>“Prepare a job submission script for the parallel executable.”</li>
<li>“Launch jobs with parallel execution.”</li>
<li>“Record and summarize the timing and accuracy of jobs.”</li>
<li>“Describe the relationship between job parallelism and
performance.”</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>We now have the tools we need to run a multi-processor job. This is a
very important aspect of HPC systems, as parallelism is one of the
primary tools we have to improve the performance of computational
tasks.</p>
<p>Our example implements a method for estimating the value of π, the
ratio of the circumference to the diameter of a circle.<br>
The program generates a large number of random points on a 1×1 square
centered on (½,½), and checks how many of these points fall inside the
unit circle. On average, π/4 of the randomly-selected points should fall
in the circle, so π can be estimated from 4<em>f</em>, where <em>f</em>
is the observed fraction of points that fall in the circle. Because each
sample is independent, this algorithm is easily implemented in
parallel.</p>
<figure><img src="../fig/pi.png" alt="Algorithm for computing pi through random sampling" class="figure mx-auto d-block"><div class="figcaption">estimating pi from random points</div>
</figure><section><h2 class="section-heading" id="get-code-for-this-episode">Get code for this episode<a class="anchor" aria-label="anchor" href="#get-code-for-this-episode"></a></h2>
<hr class="half-width"><p>The Python code you will use in this episode has been pre-written and
you can obtain a copy by: Method 1: Use the commands <code>curl</code>
or <code>wget</code> from the previous episode to download the files
directly into your working directory on Rocket and extract the archive.
Remember you will need to specify the path to these Python files in your
job submission scripts. It may be useful to <code>cd</code> into this
directory or <code>mv</code> the contents directly to the path
<code>/nobackup/proj/training/userid</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[userid@rocket.hpc</span> ~]$ curl <span class="at">-O</span> https://nclrse-training.github.io/hpc-intro-cirrus/files/python-pi-code.tar.gz</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">[userid@rocket.hpc</span> ~]$ tar <span class="at">-xvzf</span> python-pi-code.tar.gz</span></code></pre>
</div>
<p>or</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">[userid@rocket.hpc</span> ~]$ wget https://nclrse-training.github.io/hpc-intro-cirrus/files/python-pi-code.tar.gz</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">[userid@rocket.hpc</span> ~]$ tar <span class="at">-xvzf</span> python-pi-code.tar.gz</span></code></pre>
</div>
<p>Method 2: You can download a local copy of the files on your machine
and then use <code>scp</code> or <code>rsync</code> to copy the file
onto Rocket.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ scp pi.py userid@rocket.hpc:/nobackup/proj/training/userid</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ scp pi-mpi-cirrus.py userid@rocket.hpc:/nobackup/proj/training/userid</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="a-serial-solution-to-the-problem">A Serial Solution to the Problem<a class="anchor" aria-label="anchor" href="#a-serial-solution-to-the-problem"></a></h2>
<hr class="half-width"><p>We start from a Python script using concepts taught in Software
Carpentry’s <a href="https://swcarpentry.github.io/python-novice-inflammation/" class="external-link">Programming
with Python</a> workshops. We want to allow the user to specify how many
random points should be used to calculate π through a command-line
parameter. This script will only use a single CPU for its entire run, so
it’s classified as a serial process.</p>
<p>Let’s write a Python program, <code>pi.py</code>, to estimate π for
us. Start by importing the <code>numpy</code> module for calculating the
results, and the <code>sys</code> module to process command-line
parameters:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="im">import</span> sys</span></code></pre>
</div>
<p>We define a Python function <code>inside_circle</code> that accepts a
single parameter for the number of random points used to calculate π.
See <a href="https://swcarpentry.github.io/python-novice-inflammation/08-func/index.html" class="external-link">Programming
with Python: Creating Functions</a> for a review of Python functions. It
randomly samples points with both <em>x</em> and <em>y</em> on the
half-open interval [0, 1). It then computes their distances from the
origin (i.e., radii), and returns how many of those distances were less
than or equal to 1.0. All of this is done using <em>vectors</em> of
double-precision (64-bit) floating-point values.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> inside_circle(total_count):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    x <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    y <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    radii <span class="op">=</span> np.sqrt(x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    count <span class="op">=</span> <span class="bu">len</span>(radii[np.where(radii<span class="op">&lt;=</span><span class="fl">1.0</span>)])</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="cf">return</span> count</span></code></pre>
</div>
<p>Next, we create a main function to call the
<code>inside_circle</code> function and calculate π from its returned
result. See <a href="https://swcarpentry.github.io/python-novice-inflammation/12-cmdline/index.html" class="external-link">Programming
with Python: Command-Line Programs</a> for a review of <code>main</code>
functions and parsing command-line parameters.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    counts <span class="op">=</span> inside_circle(n_samples)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    my_pi <span class="op">=</span> <span class="fl">4.0</span> <span class="op">*</span> counts <span class="op">/</span> n_samples</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="bu">print</span>(my_pi)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    main()</span></code></pre>
</div>
<div id="run-the-code-on-your-development-machine-e.g.-your-laptop" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="run-the-code-on-your-development-machine-e.g.-your-laptop" class="callout-inner">
<h3 class="callout-title">Run the code on your development machine (e.g. your laptop)</h3>
<div class="callout-content">
<p>A normal workflow would be to develop and run scripts on your own
machine, then move the working code up to HPC if more resource is needed
to run it. If you have Python installed on your lapotop, feel free to
try this out: If we run the Python script locally with a command-line
parameter, as in <code>python pi.py 1024</code>, we should see the
script print its estimate of π:</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ python pi.py 1024</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ex">3.04296875</span></span></code></pre>
</div>
<div id="try-out-code-on-the-login-node" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="try-out-code-on-the-login-node" class="callout-inner">
<h3 class="callout-title">Try out code on the login node ?</h3>
<div class="callout-content">
<p>We only run small test jobs on the login node. Rather than have the
whole class attempt this and block up the login node, your instructor
will run the code as a demonstration: :::solution on Rocket, software is
only available via modules, so we need to load Python3 before we
start:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">[userid@rocket.hpc]$</span> module load Python</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="ex">[userid@rocket.hpc]$</span> python pi.py 1024</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="ex">3.04296875</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>:::</p>
</section><section><h2 class="section-heading" id="random-number-generation">Random Number Generation<a class="anchor" aria-label="anchor" href="#random-number-generation"></a></h2>
<hr class="half-width"><div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>In the preceding code, random numbers are conveniently generated
using the built-in capabilities of NumPy. In general, random-number
generation is difficult to do well, it’s easy to accidentally introduce
correlations into the generated sequence.</p>
<ul><li>Discuss why generating high quality random numbers might be
difficult.</li>
<li>Is the quality of random numbers generated sufficient for estimating
π in this implementation?</li>
</ul></div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ul><li>Computers are deterministic and produce pseudo random numbers using
an algorithm. The choice of algorithm and its parameters determines how
random the generated numbers are. Pseudo random number generation
algorithms usually produce a sequence numbers taking the previous output
as an input for generating the next number. At some point the sequence
of pseudo random numbers will repeat, so care is required to make sure
the repetition period is long and that the generated numbers have
statistical properties similar to those of true random numbers.</li>
<li>Yes.</li>
</ul></div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="measuring-performance-of-the-serial-solution">Measuring Performance of the Serial Solution<a class="anchor" aria-label="anchor" href="#measuring-performance-of-the-serial-solution"></a></h2>
<hr class="half-width"><p>The stochastic method used to estimate π should converge on the true
value as the number of random points increases. But as the number of
points increases, creating the variables <code>x</code>, <code>y</code>,
and <code>radii</code> requires more time and more memory. Eventually,
the memory required may exceed what’s available on our local laptop or
desktop, or the time required may be too long to meet a deadline. So
we’d like to take some measurements of how much memory and time the
script requires, and later take the same measurements after creating a
parallel version of the script to see the benefits of parallelizing the
calculations required.</p>
<div class="section level3">
<h3 id="estimating-memory-requirements">Estimating Memory Requirements<a class="anchor" aria-label="anchor" href="#estimating-memory-requirements"></a></h3>
<p>Since the largest variables in the script are <code>x</code>,
<code>y</code>, and <code>radii</code>, each containing
<code>n_samples</code> points, we’ll modify the script to report their
total memory required. Each point in <code>x</code>, <code>y</code>, or
<code>radii</code> is stored as a NumPy <code>float64</code>, we can use
NumPy’s <a href="https://numpy.org/doc/stable/reference/generated/numpy.dtype.html" class="external-link"><code>dtype</code></a>
function to calculate the size of a <code>float64</code>.</p>
<p>Replace the <code>print(my_pi)</code> line with the following:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>size_of_float <span class="op">=</span> np.dtype(np.float64).itemsize</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>memory_required <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> n_samples <span class="op">*</span> size_of_float <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">3</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Pi: </span><span class="sc">{</span>my_pi<span class="sc">}</span><span class="ss">, memory: </span><span class="sc">{</span>memory_required<span class="sc">}</span><span class="ss"> GiB"</span>)</span></code></pre>
</div>
<p>The first line calculates the bytes of memory required for a single
64-bit floating point number using the <code>dtype</code> function. The
second line estimates the total amount of memory required to store three
variables containing <code>n_samples</code> <code>float64</code> values,
converting the value into units of <a href="https://en.wikipedia.org/wiki/Byte#Multiple-byte_units" class="external-link">gibibytes</a>.
The third line prints both the estimate of π and the estimated amount of
memory used by the script.</p>
<p>The updated Python script is:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="kw">def</span> inside_circle(total_count):</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    x <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    y <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    radii <span class="op">=</span> np.sqrt(x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    count <span class="op">=</span> <span class="bu">len</span>(radii[np.where(radii<span class="op">&lt;=</span><span class="fl">1.0</span>)])</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="cf">return</span> count</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    counts <span class="op">=</span> inside_circle(n_samples)</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    my_pi <span class="op">=</span> <span class="fl">4.0</span> <span class="op">*</span> counts <span class="op">/</span> n_samples</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    size_of_float <span class="op">=</span> np.dtype(np.float64).itemsize</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    memory_required <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> n_samples <span class="op">*</span> size_of_float <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">3</span>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pi: </span><span class="sc">{</span>my_pi<span class="sc">}</span><span class="ss">, memory: </span><span class="sc">{</span>memory_required<span class="sc">}</span><span class="ss"> GiB"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    main()</span></code></pre>
</div>
<p>Run the script again with a few different values for the number of
samples, and see how the memory required changes:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ python pi.py 1000</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="ex">Pi:</span> 3.144, memory: 2.2351741790771484e-05 GiB</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ python pi.py 2000</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="ex">Pi:</span> 3.18, memory: 4.470348358154297e-05 GiB</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ python pi.py 1000000</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="ex">Pi:</span> 3.140944, memory: 0.022351741790771484 GiB</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="ex">[user@laptop</span> ~]$ python pi.py 100000000</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="ex">Pi:</span> 3.14182724, memory: 2.2351741790771484 GiB</span></code></pre>
</div>
<p>Here we can see that the estimated amount of memory required scales
linearly with the number of samples used. In practice, there is some
memory required for other parts of the script, but the <code>x</code>,
<code>y</code>, and <code>radii</code> variables are by far the largest
influence on the total amount of memory required.</p>
</div>
<div class="section level3">
<h3 id="estimating-calculation-time">Estimating Calculation Time<a class="anchor" aria-label="anchor" href="#estimating-calculation-time"></a></h3>
<p>Most of the calculations required to estimate π are in the
<code>inside_circle</code> function:</p>
<ol style="list-style-type: decimal"><li>Generating <code>n_samples</code> random values for <code>x</code>
and <code>y</code>.</li>
<li>Calculating <code>n_samples</code> values of <code>radii</code> from
<code>x</code> and <code>y</code>.</li>
<li>Counting how many values in <code>radii</code> are under 1.0.</li>
</ol><p>There’s also one multiplication operation and one division operation
required to convert the <code>counts</code> value to the final estimate
of π in the main function.</p>
<p>A simple way to measure the calculation time is to use Python’s
<code>datetime</code> module to store the computer’s current date and
time before and after the calculations, and calculate the difference
between those times.</p>
<p>To add the time measurement to the script, add the following line
below the <code>import sys</code> line:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> datetime</span></code></pre>
</div>
<p>Then, add the following line immediately above the line calculating
<code>counts</code>:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>start_time <span class="op">=</span> datetime.datetime.now()</span></code></pre>
</div>
<p>Add the following two lines immediately below the line calculating
<code>counts</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>end_time <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>elapsed_time <span class="op">=</span> (end_time <span class="op">-</span> start_time).total_seconds()</span></code></pre>
</div>
<p>And finally, modify the <code>print</code> statement with the
following:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Pi: </span><span class="sc">{</span>my_pi<span class="sc">}</span><span class="ss">, memory: </span><span class="sc">{</span>memory_required<span class="sc">}</span><span class="ss"> GiB, time: </span><span class="sc">{</span>elapsed_time<span class="sc">}</span><span class="ss"> s"</span>)</span></code></pre>
</div>
<p>The final Python script for the serial solution is:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="kw">def</span> inside_circle(total_count):</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    x <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    y <span class="op">=</span> np.random.uniform(size<span class="op">=</span>total_count)</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    radii <span class="op">=</span> np.sqrt(x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>    count <span class="op">=</span> <span class="bu">len</span>(radii[np.where(radii<span class="op">&lt;=</span><span class="fl">1.0</span>)])</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="cf">return</span> count</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">int</span>(sys.argv[<span class="dv">1</span>])</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>    start_time <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>    counts <span class="op">=</span> inside_circle(n_samples)</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>    my_pi <span class="op">=</span> <span class="fl">4.0</span> <span class="op">*</span> counts <span class="op">/</span> n_samples</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    end_time <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    elapsed_time <span class="op">=</span> (end_time <span class="op">-</span> start_time).total_seconds()</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    size_of_float <span class="op">=</span> np.dtype(np.float64).itemsize</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    memory_required <span class="op">=</span> <span class="dv">3</span> <span class="op">*</span> n_samples <span class="op">*</span> size_of_float <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">3</span>)</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pi: </span><span class="sc">{</span>my_pi<span class="sc">}</span><span class="ss">, memory: </span><span class="sc">{</span>memory_required<span class="sc">}</span><span class="ss"> GiB, time: </span><span class="sc">{</span>elapsed_time<span class="sc">}</span><span class="ss"> s"</span>)</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>    main()</span></code></pre>
</div>
<p>Run the script again with a few different values for the number of
samples, and see how the solution time changes:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>[user<span class="op">@</span>laptop <span class="op">~</span>]$ python pi.py <span class="dv">1000000</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>Pi: <span class="fl">3.139612</span>, memory: <span class="fl">0.022351741790771484</span> GiB, time: <span class="fl">0.034872</span> s</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>[user<span class="op">@</span>laptop <span class="op">~</span>]$ python pi.py <span class="dv">10000000</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>Pi: <span class="fl">3.1425492</span>, memory: <span class="fl">0.22351741790771484</span> GiB, time: <span class="fl">0.351212</span> s</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>[user<span class="op">@</span>laptop <span class="op">~</span>]$ python pi.py <span class="dv">100000000</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>Pi: <span class="fl">3.14146608</span>, memory: <span class="fl">2.2351741790771484</span> GiB, time: <span class="fl">3.735195</span> s</span></code></pre>
</div>
<p>Here we can see that the amount of time required scales approximately
linearly with the number of samples used. There could be some variation
in additional runs of the script with the same number of samples, since
the elapsed time is affected by other programs running on the computer
at the same time. But if the script is the most
computationally-intensive process running at the time, its calculations
are the largest influence on the elapsed time.</p>
<p>Now that we’ve developed our initial script to estimate π, we can see
that as we increase the number of samples:</p>
<ol style="list-style-type: decimal"><li>The estimate of π tends to become more accurate.</li>
<li>The amount of memory required scales approximately linearly.</li>
<li>The amount of time to calculate scales approximately linearly.</li>
</ol><p>In general, achieving a better estimate of π requires a greater
number of points. Take a closer look at <code>inside_circle</code>:
should we expect to get high accuracy on a single machine?</p>
<p>Probably not. The function allocates three arrays of size <em>N</em>
equal to the number of points belonging to this process. Using 64-bit
floating point numbers, the memory footprint of these arrays can get
quite large. Each 100,000,000 points sampled consumes 2.24 GiB of
memory. Sampling 400,000,000 points consumes 8.94 GiB of memory, and if
your machine has less RAM than that, it will grind to a halt. If you
have 16 GiB installed, you won’t quite make it to 750,000,000
points.</p>
</div>
</section><section><h2 class="section-heading" id="running-the-serial-job-on-a-compute-node">Running the Serial Job on a Compute Node<a class="anchor" aria-label="anchor" href="#running-the-serial-job-on-a-compute-node"></a></h2>
<hr class="half-width"><p>Replicate the <code>pi.py</code> script in the
<code>/nobackup/proj/training/userid</code> space on Rocket. Guidance on
how to do this can be found at the beginning of this episode.</p>
<p>Create a submission file, requesting one task on a single node. If we
do not specify a maximum walltime for the job using
<code>--time=&lt;hh:mm:ss&gt;</code> then the job will be submitted with
the <code>short</code> default maximum time of 1 minute (NB partition
names and default time limits will vary between HPC systems).</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  nano serial-pi.sh</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  cat serial-pi.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>#!/bin/bash
#SBATCH --partition=short
#SBATCH --job-name serial-pi
#SBATCH --nodes=1
#SBATCH --tasks-per-node=1


# Load the correct Python module
module load python/3.9.13

# Execute the task
python3 pi.py 100000000</code></pre>
</div>
<div id="memory-requirements" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="memory-requirements" class="callout-inner">
<h3 class="callout-title">Memory Requirements</h3>
<div class="callout-content">
<p>On some HPC systems you may need to specify the memory requirements
of the job using the <code>--mem</code>, <code>--mem-per-cpu</code>,
<code>--mem-per-gpu</code> options. However, on Cirrus you cannot
specify the memory for a job. The amount of memory you are assigned is
calculated from the amount of primary resource you request.</p>
<p>The primary resource you request on standard compute nodes are CPU
cores. The maximum amount of memory you are allocated is computed as the
number of CPU cores you requested multiplied by 1/22 of the total memory
available (as there are 22 CPU cores per node). So, if you request a
full standard node (22 cores), then you will be allocated a maximum of
all of the memory (128 GB) available on the node; however, if you
request 1 core, then you will be assigned a maximum of 128/22 = 2.9 GB
of the memory available on the node.e.</p>
</div>
</div>
</div>
<p>Then submit your job.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  sbatch serial-pi.sh</span></code></pre>
</div>
<p>As before, use the status commands to check when your job runs. Use
<code>ls</code> to locate the output file, and examine it. Is it what
you expected?</p>
<ul><li>How good is the value for π?</li>
<li>How much memory did it need?</li>
<li>How long did the job take to run?</li>
</ul><p>Modify the job script to increase both the number of samples (perhaps
by a factor of 2, then by a factor of 10), and resubmit the job each
time.</p>
<ul><li>How good is the value for π?</li>
<li>How much memory did it need?</li>
<li>Did you encounter any errors?</li>
</ul><p>Even with sufficient memory for necessary variables, a script could
require enormous amounts of time to calculate on a single CPU. To reduce
the amount of time required, we need to modify the script to use
multiple CPUs for the calculations. In the largest problem scales, we
could use multiple CPUs in multiple compute nodes, distributing the
memory requirements across all the nodes used to calculate the
solution.</p>
</section><section><h2 class="section-heading" id="running-the-parallel-job">Running the Parallel Job<a class="anchor" aria-label="anchor" href="#running-the-parallel-job"></a></h2>
<hr class="half-width"><p>We will run an example that uses the Message Passing Interface (MPI)
for parallelism – this is a common tool on HPC systems.</p>
<div id="what-is-mpi" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="what-is-mpi" class="callout-inner">
<h3 class="callout-title">What is MPI?</h3>
<div class="callout-content">
<p>The Message Passing Interface is a set of tools which allow multiple
parallel jobs to communicate with each other. Typically, a single
executable is run multiple times, possibly on different machines, and
the MPI tools are used to inform each instance of the executable about
how many instances there are, which instance it is. MPI also provides
tools to allow communication and coordination between instances. An MPI
instance typically has its own copy of all the local variables.</p>
</div>
</div>
</div>
<p>While MPI jobs can generally be run as stand-alone executables, in
order for them to run in parallel they must use an MPI <em>run-time
system</em>, which is a specific implementation of the MPI
<em>standard</em>. To do this, they should be started via a command such
as <code>mpiexec</code> (or <code>mpirun</code>, or <code>srun</code>,
etc. depending on the MPI run-time you need to use), which will ensure
that the appropriate run-time support for parallelism is included.</p>
<div id="mpi-runtime-arguments" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="mpi-runtime-arguments" class="callout-inner">
<h3 class="callout-title">MPI Runtime Arguments</h3>
<div class="callout-content">
<p>On their own, commands such as <code>mpiexec</code> can take many
arguments specifying how many machines will participate in the
execution, and you might need these if you would like to run an MPI
program on your laptop (for example). In the context of a queuing
system, however, it is frequently the case that we do not need to
specify this information as the MPI run-time will have been configured
to obtain it from the queuing system, by examining the environment
variables set when the job is launched.</p>
</div>
</div>
</div>
<div id="what-changes-are-needed-for-an-mpi-version-of-the-π-calculator" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="what-changes-are-needed-for-an-mpi-version-of-the-π-calculator" class="callout-inner">
<h3 class="callout-title">What Changes Are Needed for an MPI Version of the π Calculator?</h3>
<div class="callout-content">
<p>First, we need to import the <code>MPI</code> object from the Python
module <code>mpi4py</code> by adding an
<code>from mpi4py import MPI</code> line immediately below the
<code>import datetime</code> line.</p>
<p>Second, we need to modify the “main” function to perform the overhead
and accounting work required to:</p>
<ul><li>subdivide the total number of points to be sampled,</li>
<li>
<em>partition</em> the total workload among the various parallel
processors available,</li>
<li>have each parallel process report the results of its workload back
to the “rank 0” process, which does the final calculations and prints
out the result.</li>
</ul><p>The modifications to the serial script demonstrate four important
concepts:</p>
<ul><li>COMM_WORLD: the default MPI Communicator, providing a channel for
all the processes involved in this <code>mpiexec</code> to exchange
information with one another.</li>
<li>Scatter: A collective operation in which an array of data on one MPI
rank is divided up, with separate portions being sent out to the partner
ranks. Each partner rank receives data from the matching index of the
host array.</li>
<li>Gather: The inverse of scatter. One rank populates a local array,
with the array element at each index assigned the value provided by the
corresponding partner rank – including the host’s own value.</li>
<li>Conditional Output: since every rank is running the <em>same
code</em>, the partitioning, the final calculations, and the
<code>print</code> statement are wrapped in a conditional so that only
one rank performs these operations.</li>
</ul></div>
</div>
</div>
<p>We add the lines:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>comm <span class="op">=</span> MPI.COMM_WORLD</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>cpus <span class="op">=</span> comm.Get_size()</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>rank <span class="op">=</span> comm.Get_rank()</span></code></pre>
</div>
<p>immediately before the <code>n_samples</code> line to set up the MPI
environment for each process.</p>
<p>We replace the <code>start_time</code> and <code>counts</code> lines
with the lines:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="cf">if</span> rank <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  start_time <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  partitions <span class="op">=</span> [ <span class="bu">int</span>(n_samples <span class="op">/</span> cpus) ] <span class="op">*</span> cpus</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  counts <span class="op">=</span> [ <span class="bu">int</span>(<span class="dv">0</span>) ] <span class="op">*</span> cpus</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  partitions <span class="op">=</span> <span class="va">None</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  counts <span class="op">=</span> <span class="va">None</span></span></code></pre>
</div>
<p>This ensures that only the rank 0 process measures times and
coordinates the work to be distributed to all the ranks, while the other
ranks get placeholder values for the <code>partitions</code> and
<code>counts</code> variables.</p>
<p>Immediately below these lines, let’s</p>
<ul><li>distribute the work among the ranks with MPI
<code>scatter</code>,</li>
<li>call the <code>inside_circle</code> function so each rank can
perform its share of the work,</li>
<li>collect each rank’s results into a <code>counts</code> variable on
rank 0 using MPI <code>gather</code>.</li>
</ul><p>by adding the following three lines:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>partition_item <span class="op">=</span> comm.scatter(partitions, root<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>count_item <span class="op">=</span> inside_circle(partition_item)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>counts <span class="op">=</span> comm.gather(count_item, root<span class="op">=</span><span class="dv">0</span>)</span></code></pre>
</div>
<p>Illustrations of these steps are shown below.</p>
<div class="section level3">
<h3 id="the-parallel-message-passing-interface-mpi-process">The Parallel Message Passing Interface (MPI) Process<a class="anchor" aria-label="anchor" href="#the-parallel-message-passing-interface-mpi-process"></a></h3>
<p>Step 1: Setup the MPI environment and initialize local variables –
including the vector containing the number of points to generate on each
parallel processor:</p>
<figure><img src="../fig/initialize.png" alt="MPI initialize" class="figure mx-auto d-block"><div class="figcaption">Step1: Initialise the MPI environment</div>
</figure><p>Step 2: Distribute the number of points from the originating vector
to all the parallel processors:</p>
<figure><img src="../fig/scatter.png" alt="MPI scatter" class="figure mx-auto d-block"><div class="figcaption">Step 2: Distribute tasks</div>
</figure><p>Step 3: Perform the computation in parallel:</p>
<figure><img src="../fig/compute.png" alt="MPI compute" class="figure mx-auto d-block"><div class="figcaption">Step 3: Parallel computation</div>
</figure><p>Step 4: Retrieve counts from all the parallel processes:</p>
<figure><img src="../fig/gather.png" alt="MPI gather" class="figure mx-auto d-block"><div class="figcaption">Step 4: Gather the resulting counts</div>
</figure><p>Step 5: Print out the report:</p>
<figure><img src="../fig/finalize.png" alt="MPI finalize" class="figure mx-auto d-block"><div class="figcaption">Step 5: Finalise the result</div>
</figure><hr><p>Finally, we’ll ensure the <code>my_pi</code> through
<code>print</code> lines only run on rank 0. Otherwise, every parallel
processor will print its local value, and the report will become
hopelessly garbled:</p>
<pre><code>if rank == 0:
   my_pi = 4.0 * sum(counts) / sum(partitions)
   end_time = datetime.datetime.now()
   elapsed_time = (end_time - start_time).total_seconds()
   size_of_float = np.dtype(np.float64).itemsize
   memory_required = 3 * sum(partitions) * size_of_float / (1024**3)
   pi_specific = np.pi
   accuracy = 100*(1-my_pi/pi_specific)
   print(f"Pi: {my_pi:6f}, memory: {memory_required:6f} GiB, time: {elapsed_time:6f} s, error: {accuracy:6f}%")</code></pre>
<p>A fully commented version of the final MPI parallel python code is
available: <a href="https://nclrse-training.github.io/hpc-intro-cirrus/files/pi-mpi-cirrus.py" class="external-link">pi-mpi-cirrus.py</a>.</p>
<p>Our purpose here is to exercise the parallel workflow of the cluster,
not to optimize the program to minimize its memory footprint. Rather
than push our local machines to the breaking point (or, worse, the login
node), let’s give it to a cluster node with more resources.</p>
<p>Create a submission file, requesting more than one task on a single
node:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  nano parallel-pi.sh</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  cat parallel-pi.sh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>#!/bin/bash
#SBATCH --partition=short
#SBATCH --job-name parallel-pi
#SBATCH --nodes=1
#SBATCH --tasks-per-node=4
#SBATCH --time=00:01

# Load the correct Python module
module load python/3.9.13

# Execute the task
srun python pi-mpi-cirrus.py 100000000</code></pre>
</div>
<p>Then submit your job.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">[userid@login01</span> ~]$  sbatch parallel-pi.sh</span></code></pre>
</div>
<p>As before, use the status commands to check when your job runs. Use
<code>ls</code> to locate the output file, and examine it. Is it what
you expected?</p>
<ul><li>How good is the value for π?</li>
<li>How much memory did it need?</li>
<li>How much faster was this run than the serial run with 100000000
points?</li>
</ul><p>Modify the job script to increase the number of samples (perhaps by a
factor of 2, then by a factor of 10), and resubmit the job each time.
You can also increase the number of CPUs.</p>
<ul><li>How good is the value for π?</li>
<li>How much memory did it need?</li>
<li>How long did the job take to run?</li>
</ul></div>
</section><section><h2 class="section-heading" id="how-much-does-mpi-improve-performance">How Much Does MPI Improve Performance?<a class="anchor" aria-label="anchor" href="#how-much-does-mpi-improve-performance"></a></h2>
<hr class="half-width"><p>In theory, by dividing up the π calculations among <em>n</em> MPI
processes, we should see run times reduce by a factor of <em>n</em>. In
practice, some time is required to start the additional MPI processes,
for the MPI processes to communicate and coordinate, and some types of
calculations may only be able to run effectively on a single CPU.</p>
<p>Additionally, if the MPI processes operate on different physical CPUs
in the computer, or across multiple compute nodes, additional time is
required for communication compared to all processes operating on a
single CPU.</p>
<p><a href="https://en.wikipedia.org/wiki/Amdahl's_law" class="external-link">Amdahl’s
Law</a> is one way of predicting improvements in execution time for a
<strong>fixed</strong> parallel workload. If a workload needs 20 hours
to complete on a single core, and one hour of that time is spent on
tasks that cannot be parallelized, only the remaining 19 hours could be
parallelized. Even if an infinite number of cores were used for the
parallel parts of the workload, the total run time cannot be less than
one hour.</p>
<p>In practice, it’s common to evaluate the parallelism of an MPI
program by</p>
<ul><li>running the program across a range of CPU counts,</li>
<li>recording the execution time on each run,</li>
<li>comparing each execution time to the time when using a single
CPU.</li>
</ul><p>The speedup factor <em>S</em> is calculated as the single-CPU
execution time divided by the multi-CPU execution time. For a laptop
with 8 cores, the graph of speedup factor versus number of cores used
shows relatively consistent improvement when using 2, 4, or 8 cores, but
using additional cores shows a diminishing return.</p>
<div class="section level3">
<h3 id="laptop-performance">Laptop performance<a class="anchor" aria-label="anchor" href="#laptop-performance"></a></h3>
<figure><img src="../fig/laptop-mpi_Speedup_factor.png" alt="MPI speedup factors on an 8-core laptop" class="figure mx-auto d-block"><div class="figcaption">MPI speedup factors on an 8-core laptop</div>
</figure><p>For a set of HPC nodes containing 28 cores each, the graph of speedup
factor versus number of cores shows consistent improvements up through
three nodes and 84 cores, but <strong>worse</strong> performance when
adding a fourth node with an additional 28 cores. This is due to the
amount of communication and coordination required among the MPI
processes requiring more time than is gained by reducing the amount of
work each MPI process has to complete. This communication overhead is
not included in Amdahl’s Law.</p>
</div>
<div class="section level3">
<h3 id="hpc-performance">HPC performance<a class="anchor" aria-label="anchor" href="#hpc-performance"></a></h3>
<figure><img src="../fig/hpc-mpi_Speedup_factor.png" alt="MPI speedup factors on HPC" class="figure mx-auto d-block"><div class="figcaption">MPI speedup factors on HPC</div>
</figure><p>In practice, MPI speedup factors are influenced by:</p>
<ul><li>CPU design,</li>
<li>the communication network between compute nodes,</li>
<li>the MPI library implementations, and</li>
<li>the details of the MPI program itself.</li>
</ul><p>In an HPC environment, we try to reduce the execution time for all
types of jobs, and MPI is an extremely common way to combine dozens,
hundreds, or thousands of CPUs into solving a single problem. To learn
more about parallelization, see the <a href="http://www.hpc-carpentry.org/hpc-parallel-novice/" class="external-link">parallel novice
lesson</a> lesson.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>“Parallel programming allows applications to take advantage of
parallel hardware; serial code will not ‘just work.’”</li>
<li>“Distributed memory parallelism is a common case, using the Message
Passing Interface (MPI).”</li>
<li>“The queuing system facilitates executing parallel tasks.”</li>
<li>“Performance improvements from parallel execution do not scale
linearly.”</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/50-transferring-files.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/70-resources.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/50-transferring-files.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Transferring files
        </a>
        <a class="chapter-link float-end" href="../instructor/70-resources.html" rel="next">
          Next: Using resources...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/NclRSE-Training/hpc-intro-rocket/edit/main/episodes/60-parallel-job.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/NclRSE-Training/hpc-intro-rocket/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/NclRSE-Training/hpc-intro-rocket/" class="external-link">Source</a></p>
				<p><a href="https://github.com/NclRSE-Training/hpc-intro-rocket/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:workshoporganisation@group.newcastle.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://NclRSE-Training.github.io/hpc-intro-rocket/instructor/60-parallel-job.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Running a parallel job",
  "creativeWorkStatus": "active",
  "url": "https://NclRSE-Training.github.io/hpc-intro-rocket/instructor/60-parallel-job.html",
  "identifier": "https://NclRSE-Training.github.io/hpc-intro-rocket/instructor/60-parallel-job.html",
  "dateCreated": "2025-02-12",
  "dateModified": "2025-03-06",
  "datePublished": "2025-03-10"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

